AWSTemplateFormatVersion: '2010-09-09'
Description: Serverless Deployment for Minerva

Transform:
    - AWS::Serverless-2016-10-31

Parameters:
    GoogleAccountClient:
        Type: String
    GoogleAccountSecret:
        Type: String
    GoogleAccountToken:
        Type: String
    SlackToken:
        Type: String
    DeployEnvironment:
        Type: String
        Default: development
        AllowedValues:
            - development
            - production
Conditions:
    IsProduction: !Equals [!Ref DeployEnvironment, "production"]

Globals:
    Api:
        OpenApiVersion: 3.0.3
    Function:
        Runtime: nodejs16.x
        Environment:
            Variables:
                production_googleaccount_redirect: "https://developers.google.com/oauthplayground/"
                production_slack_token: !Ref SlackToken
                production_googleaccount_client: !Ref GoogleAccountClient
                production_googleaccount_secret: !Ref GoogleAccountSecret
                production_googleaccount_token: !Ref GoogleAccountToken

Resources:
    MinervaApi:
        Type: AWS::Serverless::Api
        Properties:
            StageName: !Ref DeployEnvironment

    SlackCommandsSync:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: !Sub "minerva-${DeployEnvironment}-slackCommandsSync"
            Handler: bundle.slack_commands_sync
            MemorySize: 128
            Timeout: 100
            Policies:
                - AWSLambdaBasicExecutionRole
            Events:
                SlackEvent:
                    Type: Api
                    Properties:
                        RestApiId: !Ref MinervaApi
                        Path: /slack/commands-sync
                        Method: post
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Target: "es2020"
                Sourcemap: !If [IsProduction, false, true]
                EntryPoints: 
                - src/index.js

    SlackCommandsAsync:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: !Sub "minerva-${DeployEnvironment}-slackCommandsAsync"
            Handler: bundle.slack_commands_async
            MemorySize: 128
            Timeout: 100
            Policies:
                - AWSLambdaBasicExecutionRole
            Events:
                SlackEvent:
                    Type: Api
                    Properties:
                        RestApiId: !Ref MinervaApi
                        Path: /slack/commands-async
                        Method: post
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Target: "es2020"
                Sourcemap: !If [IsProduction, false, true]
                EntryPoints: 
                - src/index.js

    InteractivitySync:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: !Sub "minerva-${DeployEnvironment}-interactivitySync"
            Handler: bundle.interactivity_sync
            MemorySize: 128
            Timeout: 100
            Policies:
                - AWSLambdaBasicExecutionRole
            Events:
                SlackEvent:
                    Type: Api
                    Properties:
                        RestApiId: !Ref MinervaApi
                        Path: /slack/interactivity-sync
                        Method: post
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Target: "es2020"
                Sourcemap: !If [IsProduction, false, true]
                EntryPoints: 
                - src/index.js

    InteractivityAsync:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: !Sub "minerva-${DeployEnvironment}-interactivityAsync"
            Handler: bundle.interactivity_async
            MemorySize: 128
            Timeout: 100
            Policies:
                - AWSLambdaBasicExecutionRole
            Events:
                SlackEvent:
                    Type: Api
                    Properties:
                        RestApiId: !Ref MinervaApi
                        Path: /slack/interactivity-async
                        Method: post
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Target: "es2020"
                Sourcemap: !If [IsProduction, false, true]
                EntryPoints: 
                - src/index.js    

    Scheduled:
        Type: AWS::Serverless::Function
        Properties:
            FunctionName: !Sub "minerva-${DeployEnvironment}-scheduled"
            Handler: bundle.scheduled
            MemorySize: 128
            Timeout: 100
            Policies:
                - AWSLambdaBasicExecutionRole
            Events:
                SlackEvent:
                    Type: Api
                    Properties:
                        RestApiId: !Ref MinervaApi
                        Path: /slack/scheduled
                        Method: post
        Metadata:
            BuildMethod: esbuild
            BuildProperties:
                Target: "es2020"
                Sourcemap: !If [IsProduction, false, true]
                EntryPoints: 
                - src/index.js